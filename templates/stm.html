{% extends 'base.html' %}
{% block title %} {{ title }} {% endblock %}

{% block content %}

    <legend> {{ legend }} </legend>

    <div class="content-section">
        <p style="margin: 0">This page provides an interface to measure the performance of a given translation with
            syntax trees based metric.</p>
    </div>

    <div class="container" id="text-type" style="padding: 0">
        <div class="input-group mb-3 options" style="margin-left: 0">
            <div class="input-group-prepend">
                <label class="input-group-text" for="metric-select">Type</label>
            </div>
            <select class="custom-select" id="text-type-select" name="text-type" required style="margin-right: 0">
                <option selected disabled value="">Choose Type</option>
                <option value="sentence" id="sentence">Sentence-level</option>
                <option value="corpus" id="corpus">Corpus-level</option>
            </select>
        </div>
    </div>

    <form id="sentence-level" class="form-control d-none" method="post" action="{{ url_for('stm.process_stm') }}">
        <div class="container border-bottom" id="preprocessing">
            <h5 class="display-5">Text pre-processing</h5>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="contractions" name="contractions" value="1">
                <label class="form-check-label" for="contractions">Expand contractions (e.g. I`m -> I am)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="spec-chars" name="spec-chars" value="1">
                <label class="form-check-label" for="spec-chars">Remove special characters (e.g. ",")</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="lowercase" name="lowercase" value="1">
                <label class="form-check-label" for="lowercase">Lowercase</label>
            </div>
        </div>

        {{ form.csrf_token }}

        <div class="container border-bottom" id="depth-select" style="padding: 0">
            <div class="input-group mb-3 options" style="margin-left: 0">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="depth">Depth</label>
                </div>
                <select class="custom-select" id="depth" name="depth" required style="margin-right: 0">
                    <option selected disabled value="">Select Depth</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                </select>
            </div>
        </div>

        <div class="container border-bottom" id="sentiment-analysis-sentence" style="padding: 10px">
            <h5 class="display-5">Sentiment Analysis</h5>
            <p style="margin-bottom: 0">Use sentiment analysis classifier:</p>
            <label class="switch" for="sentiment-sentence">
                <input type="checkbox" id="sentiment-sentence" name="sentiment-sentence" value="1">
                <span class="slider round"></span>
            </label>
            <p class="analyzer-trivia">Enables sentiment analyzer trained on ~10000 tweets.
                <br>It tries to predict the polarity (e.g. <i>positive/negative</i>) of the reference and hypothesis.
                STM score is scaled to <strong>0.7</strong> and if predictions match <strong>0.3</strong> is added to
                the <strong>per-sentence</strong> score.</p>
        </div>

        <div class="d-flex bd-highlight mb-3" id="sentence-boxes">
            <div class="p-2 bd-highlight">Type your hypothesis translation here:
                <p>{{ form.text_hypothesis }}</p>
            </div>
            <div class="ml-auto p-2 bd-highlight">Type your reference translation here:
                <p>{{ form.text_reference }}</p>
            </div>
        </div>

        <input class="btn btn-outline-secondary mb-2" id="submit-button" type="submit" value="Evaluate">
    </form>

    <form id="corpus-level" class="form-control d-none" method="post" action="{{ url_for('stm.process_stm_corpus') }}"
          enctype="multipart/form-data">

        <div class="container border-bottom" id="preprocessing">
            <h5 class="display-5">Text pre-processing</h5>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="contractions" name="contractions" value="1">
                <label class="form-check-label" for="contractions">Expand contractions (e.g. I'm -> I am)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="spec-chars" name="spec-chars" value="1">
                <label class="form-check-label" for="spec-chars">Remove special characters (e.g. ",")</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="lowercase" name="lowercase" value="1">
                <label class="form-check-label" for="lowercase">Lowercase</label>
            </div>
        </div>

        <div class="container" id="depth-select" style="padding: 0">
            <div class="input-group mb-3 options" style="margin-left: 0">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="depth">Depth</label>
                </div>
                <select class="custom-select" id="depth" name="depth" required style="margin-right: 0">
                    <option selected disabled value="">Select Depth</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                </select>
            </div>
        </div>

        <div class="container border-top" id="sentiment-analysis" style="padding: 10px">
            <h5 class="display-5">Sentiment Analysis</h5>
            <p style="margin-bottom: 0">Use sentiment analysis classifier:</p>
            <label class="switch" for="sentiment">
                <input type="checkbox" id="sentiment" name="sentiment" value="1">
                <span class="slider round"></span>
            </label>
            <p class="analyzer-trivia">Enables sentiment analyzer trained on ~10000 tweets.
                <br>It tries to predict the polarity (e.g. <i>positive/negative</i>) of each reference and hypothesis
                sentence.
                STM score is scaled to <strong>0.7</strong> and if predictions match <strong>0.3</strong> is added to
                the <strong>per-sentence</strong> score.</p>
        </div>

        <div class="container border-top" id="genre-analysis" style="padding: 10px">
            <h5 class="display-5">Genre Analysis</h5>
            <p style="margin-bottom: 0">Use genre analysis classifier:</p>
            <label class="switch" for="genre">
                <input type="checkbox" id="genre" name="genre" value="1">
                <span class="slider round"></span>
            </label>
            <p class="analyzer-trivia">Enables genre analyzer trained on ~20000 books.
                <br>It tries to predict the genre (e.g. <i>thriller/historical</i>) of the reference and hypothesis
                sentence.
                STM score is scaled to <strong>0.7</strong> and if predictions match <strong>0.3</strong> is added to
                the <strong>per-sentence</strong> score.</p>
        </div>

        <div class="content-section">
            <p style="margin-bottom: 0"><strong>NOTE:</strong> If both the sentiment and genre classifiers are enabled
                then their scores are scaled to <strong>0.15</strong> for each so that the maximum STM score is <strong>1</strong>
                in all cases.</p>
        </div>

        <div class="form-group content-section">
            <label for="hypotheses-upload">Upload file with hypotheses</label>
            <input type="file" name="hypothesis-file" class="form-control-file" required id="hypotheses-upload"
                   accept=".txt">
        </div>

        <div class="form-group content-section">
            <label for="references-upload">Upload file with references</label>
            <input type="file" name="references-file" class="form-control-file" required id="references-upload"
                   accept=".txt">
        </div>
        <input class="btn btn-outline-secondary mb-2" id="submit-button" type="submit" value="Evaluate"
               style="margin: 0">
    </form>

    <hr>

    {# TODO: Consider displaying the syntax trees #}
    {% if info %}
        <div id="output-info">
            {% if info.hyp %}
                <div class="container">
                    <div class="row">
                        <div class="col border">
                            <strong>Hypothesis</strong>: <br>{{ info.hyp }}
                        </div>
                        <div class="col border">
                            <strong>Reference</strong>: <br>{{ info.ref }}
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="container-md">
                <ul class="list-group">
                    {% if info.sentiment %}
                        <li class="list-group-item text-center">
                            <strong>Sentiment analysis enabled:</strong> Yes
                        </li>
                    {% endif %}
                    {% if info.genre %}
                        <li class="list-group-item text-center">
                            <strong>Genre analysis enabled:</strong> Yes
                            <div class="container" id="corpora-genre">
                                <div class="row">
                                    <div class="col border">
                                        <strong>Hypothesis corpora genre</strong>:
                                        <br>{{ info.corpora_genre.hypothesis }}
                                    </div>
                                    <div class="col border">
                                        <strong>Reference corpora genre</strong>:
                                        <br>{{ info.corpora_genre.reference }}
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                    <li class="list-group-item text-center">
                        <strong>Depth</strong>: {{ info.depth }}<br>
                        <strong>{{ info.metric }} Score</strong>: {{ info.value }}
                    </li>
                </ul>
            </div>
        </div>
        {% if info.per_sentence_summary %}
            <div class="content-section" id="per-sentence-summary">
                <h5 class="display-5">Per-sentence summary</h5>
                {% for sentence_info in info.per_sentence_summary %}
                    <div class="content-section">
                        <div class="row">
                            <div class="col border per-sentence-info"><strong>Reference
                                sentence</strong>: {{ sentence_info.reference }}</div>
                            <div class="col border per-sentence-info"><strong>Hypothesis
                                sentence</strong>: {{ sentence_info.hypothesis }}</div>
                        </div>
                        {% if info.sentiment %}
                            <div class="row">
                                <div class="col border per-sentence-info"><strong>Reference
                                    sentiment</strong>: {{ sentence_info.sentiment_ref }}</div>
                                <div class="col border per-sentence-info"><strong>Hypothesis
                                    sentiment</strong>: {{ sentence_info.sentiment_hyp }}</div>
                            </div>
                        {% endif %}

                        {% if info.genre %}
                            <div class="row">
                                <div class="col border per-sentence-info"><strong>Reference
                                    genre</strong>: {{ sentence_info.genre_ref }}</div>
                                <div class="col border per-sentence-info"><strong>Hypothesis
                                    genre</strong>: {{ sentence_info.genre_hyp }}</div>
                            </div>
                        {% endif %}

                        <p class="stm-score text-center"><strong>STM Score</strong>: {{ sentence_info.score }} out of
                            1.0</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/metrics.js') }}"></script>
{% endblock content %}

{% block sidebar %}
    <div class="col-md-4">
        <div class="content-section">
            <h3>References</h3>
            <ul class="list-group">
                <li class="list-group-item list-group-item-light"><a class="btn-link" target="_blank"
                                                                     href="https://en.wikipedia.org/wiki/Sentence_diagram#Constituency_and_dependency">Sentence
                    Trees Explanation</a></li>
                <li class="list-group-item list-group-item-light"><a class="btn-link"
                                                                     href="https://www.aclweb.org/anthology/W05-0904/"
                                                                     target="_blank">Paper</a></li>
            </ul>
        </div>
        <div class="content-section d-none" id="file-structure">
            <h5 class="display-5">Notes on the file structure:</h5>
            <ul style="margin-bottom: 0">
                <li>Both files should be in plain text;</li>
                <li>Both files should have <strong>the same length in terms of sentences;</strong><br></li>
                <li>Sentences are to be split by <strong>. &nbsp;</strong> (period sign <strong>and whitespace</strong>);
                </li>
                <li>These sentences should be aligned one-to-one, i.e.:
                    <ul>
                        <li>reference1-hypothesis1</li>
                        <li>reference2-hypothesis2</li>
                        <li>reference3-hypothesis3</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
{% endblock %}
